<<<<<<< HEAD
=======

<!--PARTE 1 INICIO-->
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<<<<<<< HEAD
  <title>Finanzas — Joyería (MVP)</title>
=======
  <title>App-Registro — Inventario & POS (Demo) - Versión Final Corregida</title>
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f

  <!-- Tailwind para estilos -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js para gráficas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
<<<<<<< HEAD
    /* pequeños ajustes estéticos */
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 0.95rem; }
    .hidden { display: none !important; }
  </style>
  <!-- NOTA: NO incluir firebaseConfig aquí para evitar redeclare -->
=======
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 0.95rem; }
    .hidden { display: none !important; }
    .small { font-size: 0.85rem; }
  </style>
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
</head>
<body class="bg-slate-50 text-slate-800">
  <div id="app" class="max-w-6xl mx-auto p-4">
    <!-- AUTH -->
    <div id="authView" class="mt-10">
      <h1 class="text-2xl font-bold mb-4">Acceso</h1>
      <div class="grid md:grid-cols-2 gap-6">
        <form id="loginForm" class="bg-white p-4 rounded shadow space-y-3">
          <h2 class="font-semibold">Iniciar sesión</h2>
          <input id="loginEmail" type="email" required placeholder="Email" class="w-full border rounded p-2">
          <input id="loginPass" type="password" required placeholder="Contraseña" class="w-full border rounded p-2">
          <button class="w-full bg-slate-900 text-white py-2 rounded">Entrar</button>
        </form>

<<<<<<< HEAD
       <!-- <form id="registerForm" class="bg-white p-4 rounded shadow space-y-3">
=======
        <form id="registerForm" class="bg-white p-4 rounded shadow space-y-3">
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
          <h2 class="font-semibold">Crear cuenta</h2>
          <input id="regName" type="text" required placeholder="Tu nombre (p.ej. Brandon)" class="w-full border rounded p-2">
          <input id="regEmail" type="email" required placeholder="Email" class="w-full border rounded p-2">
          <input id="regPass" type="password" required placeholder="Contraseña" class="w-full border rounded p-2">
<<<<<<< HEAD
          <!- //No pedimos % de ahorro en registro// -->
          <button class="w-full bg-emerald-600 text-white py-2 rounded">Crear</button>
        </form>-->
=======
          <button class="w-full bg-emerald-600 text-white py-2 rounded">Crear</button>
        </form>
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
      </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="mainView" class="hidden">
      <div class="flex items-center justify-between mt-4">
        <div>
<<<<<<< HEAD
          <h1 class="text-2xl font-bold">Panel — Joyería</h1>
          <p id="companyName" class="text-sm text-slate-600"></p>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnSelectCompany" class="px-3 py-2 rounded border">Empresa</button>
=======
          <h1 class="text-2xl font-bold">Panel — Empresa Demo</h1>
          <p id="companyName" class="text-sm text-slate-600"></p>
        </div>
        <div class="flex items-center gap-2">
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
          <button id="btnPerfil" class="px-3 py-2 rounded border">Perfil</button>
          <button id="btnLogout" class="px-3 py-2 rounded bg-slate-900 text-white">Salir</button>
        </div>
      </div>

<<<<<<< HEAD
      <!-- KPIs -->
      <div class="grid md:grid-cols-4 gap-4 mt-4">
        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-slate-500">Caja Empresa</div>
          <div id="kpiCajaEmpresa" class="text-2xl font-semibold">$0</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-slate-500">Caja Brandon</div>
          <div id="kpiCajaBrandon" class="text-2xl font-semibold">$0</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-slate-500">Caja Socia</div>
          <div id="kpiCajaSocia" class="text-2xl font-semibold">$0</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-slate-500">Deudas Totales</div>
=======
      <!-- KPIs SIMPLIFICADOS (solo lo esencial solicitado) -->
      <div class="grid md:grid-cols-3 gap-4 mt-4">
        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-slate-500">Caja Empresa</div>
          <!-- saldo en tiempo real (suscripción a balances) -->
          <div id="kpiCajaEmpresa" class="text-2xl font-semibold">$0</div>

          <!-- Controles para consultar caja por rango -->
          <div class="mt-2 text-xs text-slate-600">
            <button id="btnCajaHoy" class="px-2 py-1 border rounded mr-1">Hoy</button>
            <button id="btnCaja7d" class="px-2 py-1 border rounded mr-1">7 días</button>
            <button id="btnCaja30d" class="px-2 py-1 border rounded mr-1">30 días</button>
            <button id="btnCajaCustomToggle" class="px-2 py-1 border rounded">Rango</button>

            <div id="cajaCustom" class="mt-2 hidden">
              <input type="date" id="cajaFrom" class="border rounded p-1 mr-1">
              <input type="date" id="cajaTo" class="border rounded p-1 mr-1">
              <button id="btnCajaCustom" class="px-2 py-1 bg-slate-900 text-white rounded">Ver</button>
            </div>
          </div>

          <!-- Aquí mostramos el resultado del rango consultado (no reemplaza la caja en tiempo real) -->
          <div id="kpiCajaRangeResult" class="text-sm text-slate-500 mt-2">Caja en rango: —</div>
        </div>

        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-slate-500">Inventario (unidades)</div>
          <div id="kpiInventarioTotal" class="text-2xl font-semibold">0</div>
        </div>

        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-slate-500">Deudas (si aplica)</div>
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
          <div id="kpiDeudas" class="text-2xl font-semibold">$0</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="mt-6">
        <div class="flex gap-2 flex-wrap">
          <button data-tab="ventas" class="tab-btn px-3 py-2 rounded bg-slate-900 text-white">Ventas</button>
<<<<<<< HEAD
=======
          <button data-tab="inventario" class="tab-btn px-3 py-2 rounded border">Inventario</button>
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
          <button data-tab="gastos" class="tab-btn px-3 py-2 rounded border">Gastos</button>
          <button data-tab="deudas" class="tab-btn px-3 py-2 rounded border">Deudas</button>
          <button data-tab="metas" class="tab-btn px-3 py-2 rounded border">Metas</button>
          <button data-tab="movimientos" class="tab-btn px-3 py-2 rounded border">Movimientos</button>
          <button data-tab="estadisticas" class="tab-btn px-3 py-2 rounded border">Estadísticas</button>
        </div>

<<<<<<< HEAD
        <!-- VENTAS -->
        <section id="tab-ventas" class="tab mt-4">
          <div class="grid md:grid-cols-2 gap-4">
            <form id="formVenta" class="bg-white p-4 rounded shadow space-y-2">
              <h3 class="font-semibold text-lg">Registrar Venta</h3>
              <input type="date" id="ventaFecha" required class="w-full border rounded p-2">
              <input type="text" id="ventaProducto" placeholder="Producto" required class="w-full border rounded p-2">
              <input type="number" id="ventaCosto" placeholder="Costo del producto" step="0.01" min="0" required class="w-full border rounded p-2">
              <input type="number" id="ventaPrecio" placeholder="Precio de venta" step="0.01" min="0" required class="w-full border rounded p-2">
              <textarea id="ventaNotas" placeholder="Notas" class="w-full border rounded p-2"></textarea>

              <div class="bg-slate-50 rounded p-3">
                <div class="text-sm font-medium">Origen de la inversión</div>
                <select id="ventaFinanciadaPor" class="w-full border rounded p-2 mt-2">
                  <option value="empresa">Empresa</option>
                  <option value="brandon">Brandon</option>
                  <option value="socia">Socia</option>
                </select>

                <label class="flex items-center gap-2 text-sm mt-3">
                  <input id="ventaManualToggle" type="checkbox" class="w-4 h-4">
                  <span>Usar distribución manual (activar para decidir reinversión / pagos manualmente)</span>
                </label>

                <div id="manualDistribFields" class="mt-3 hidden">
                  <div class="text-sm font-medium">Distribución manual</div>
                  <div class="grid grid-cols-2 gap-2 mt-2">
                    <input type="number" id="asigReinv" placeholder="Reinversión" step="0.01" min="0" class="border rounded p-2">
                    <input type="number" id="asigBrandon" placeholder="Brandon" step="0.01" min="0" class="border rounded p-2">
                    <input type="number" id="asigSocia" placeholder="Socia" step="0.01" min="0" class="border rounded p-2">
                    <input type="number" id="asigPagoDeuda" placeholder="Pago deuda" step="0.01" min="0" class="border rounded p-2">
                  </div>
                </div>

                <div id="autoDistribNote" class="mt-3 text-sm text-slate-600">
                  Modo automático: se devuelve la inversión al inversor (si financió la empresa se divide 50/50 si la empresa no tiene fondos). La utilidad se reparte 50/50 entre Brandon y la Socia.
                </div>
                <p id="ventaResumen" class="text-sm text-slate-600 mt-2"></p>
                <p id="sugerenciaAhorro" class="text-xs text-slate-600 mt-1"></p>
              </div>

              <input type="hidden" id="editingSaleId" value="">
              <button class="w-full bg-emerald-600 text-white py-2 rounded">Guardar Venta</button>
            </form>

            <div class="bg-white p-4 rounded shadow overflow-auto">
              <h3 class="font-semibold text-lg mb-2">Historial de Ventas</h3>
              <table class="w-full text-sm">
                <thead class="text-left">
                  <tr>
                    <th>Fecha</th><th>Producto</th><th>Precio</th><th>Costo</th><th>Utilidad</th><th>Margen</th><th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbVentas"></tbody>
=======
        <!-- VENTAS (POS multiproducto) -->
        <section id="tab-ventas" class="tab mt-4">
          <div class="grid md:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded shadow">
              <h3 class="font-semibold text-lg">POS — Registrar Venta</h3>

              <!-- Cart (se generan filas dinámicas) -->
              <div id="cartContainer" class="mt-3">
                <table class="w-full" id="cartTable">
                  <thead class="text-left">
                    <tr>
                      <th>Producto</th><th>Cant.</th><th>Precio</th><th>Subtotal</th><th></th>
                    </tr>
                  </thead>
                  <tbody id="cartBody"></tbody>
                </table>
                <div class="flex gap-2 mt-3">
                  <button id="btnAddCartLine" class="px-3 py-2 bg-slate-900 text-white rounded">Agregar artículo</button>
                  <button id="btnClearCart" class="px-3 py-2 border rounded">Limpiar</button>
                </div>

                <div class="mt-4 space-y-2">
                  <label class="text-sm">Cliente (opcional)</label>
                  <input id="saleClient" class="w-full border rounded p-2" placeholder="Nombre / teléfono">
                  <label class="text-sm">Tipo de venta</label>
                  <select id="saleType" class="w-full border rounded p-2">
                    <option value="minorista">Minorista</option>
                    <option value="mayorista">Mayorista</option>
                  </select>
                  <label class="text-sm">Canal</label>
                  <select id="saleChannel" class="w-full border rounded p-2">
                    <option value="fisico">Físico</option>
                    <option value="online">Online</option>
                  </select>
                </div>

                <div class="mt-4 text-right">
                  <div class="text-sm">Total</div>
                  <div id="cartTotal" class="text-2xl font-semibold">$0</div>
                  <button id="btnSubmitSale" class="mt-3 w-full bg-emerald-600 text-white py-2 rounded">Confirmar venta</button>
                </div>
              </div>
            </div>

            <div class="bg-white p-4 rounded shadow overflow-auto">
             <h3 class="font-semibold text-lg mb-2">Historial de Ventas</h3>
 <table class="w-full text-sm">
  <thead class="text-left">
    <tr>
      <th>Fecha</th>
      <th>Cliente</th>
      <th>Total</th>
      <th>Items</th>
      <th>Acciones</th> <!-- 👈 NUEVA COLUMNA -->
    </tr>
  </thead>
  <tbody id="tbVentas"></tbody>
</table>

            </div>
          </div>
        </section>

        <!-- INVENTARIO -->
        <section id="tab-inventario" class="tab hidden mt-4">
          <div class="grid md:grid-cols-2 gap-4">
            <form id="formProduct" class="bg-white p-4 rounded shadow space-y-2">
              <h3 class="font-semibold text-lg">Crear Producto / Variante</h3>

              <input type="text" id="prodName" placeholder="Nombre (ej: Polo Clásico)" required class="w-full border rounded p-2" />
              <input type="text" id="prodSku" placeholder="SKU (opcional)" class="w-full border rounded p-2" />
              <div class="grid grid-cols-3 gap-2">
                <input id="prodGender" placeholder="Género (Hombre/Mujer/Unisex)" class="border rounded p-2" />
                <input id="prodSize" placeholder="Talla (S/M/L/...)" class="border rounded p-2" />
                <input id="prodColor" placeholder="Color (Azul/Rojo/...)" class="border rounded p-2" />
              </div>
              <input type="text" id="prodTeam" placeholder="Equipo (opcional)" class="w-full border rounded p-2" />
              <div class="grid grid-cols-2 gap-2">
                <input type="number" id="prodCost" placeholder="Costo" step="0.01" min="0" class="border rounded p-2" />
                <input type="number" id="prodPrice" placeholder="Precio" step="0.01" min="0" class="border rounded p-2" />
              </div>

              <div class="grid grid-cols-2 gap-2">
                <input type="number" id="prodInitialStock" placeholder="Stock inicial (cantidad)" min="0" step="1" class="border rounded p-2" />
                <input type="text" id="prodNotes" placeholder="Notas (opcional)" class="border rounded p-2" />
              </div>

              <button id="btnCreateProduct" class="w-full bg-emerald-600 text-white py-2 rounded">Crear producto</button>
            </form>

            <div class="bg-white p-4 rounded shadow overflow-auto">
              <h3 class="font-semibold text-lg mb-2">Inventario</h3>
              <table class="w-full text-sm">
                <thead class="text-left">
                  <tr><th>Nombre</th><th>Attrs</th><th>Precio</th><th>Stock</th><th>Acciones</th></tr>
                </thead>
                <tbody id="tbInventory"></tbody>
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
              </table>
            </div>
          </div>
        </section>

<<<<<<< HEAD
        <!-- GASTOS -->
        <section id="tab-gastos" class="tab hidden mt-4">
=======
        <!-- Secciones que mantenemos (puedes expandirlas luego) -->
        <section id="tab-gastos" class="tab hidden mt-4">
          <!-- Mantengo tu formulario original de gastos aquí -->
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
          <div class="grid md:grid-cols-2 gap-4">
            <form id="formGasto" class="bg-white p-4 rounded shadow space-y-2">
              <h3 class="font-semibold text-lg">Registrar Gasto</h3>
              <input type="date" id="gastoFecha" required class="w-full border rounded p-2">
              <input type="text" id="gastoCat" placeholder="Categoría" required class="w-full border rounded p-2">
              <input type="number" id="gastoMonto" placeholder="Monto" step="0.01" min="0" required class="w-full border rounded p-2">
              <input type="text" id="gastoDesc" placeholder="Descripción" class="w-full border rounded p-2">
              <select id="gastoPagadoPor" class="w-full border rounded p-2">
                <option value="empresa">Empresa</option>
<<<<<<< HEAD
                <option value="brandon">Brandon</option>
                <option value="socia">Socia</option>
=======
                <option value="otro">Otro</option>
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
              </select>
              <input type="hidden" id="editingGastoId" value="">
              <button class="w-full bg-emerald-600 text-white py-2 rounded">Guardar Gasto</button>
            </form>
<<<<<<< HEAD

            <div class="bg-white p-4 rounded shadow overflow-auto">
              <h3 class="font-semibold text-lg mb-2">Historial de Gastos</h3>
              <table class="w-full text-sm">
                <thead class="text-left">
                  <tr>
                    <th>Fecha</th><th>Categoría</th><th>Monto</th><th>Pagado por</th><th>Descripción</th><th>Acciones</th>
                  </tr>
                </thead>
=======
            <div class="bg-white p-4 rounded shadow overflow-auto">
              <h3 class="font-semibold text-lg mb-2">Historial de Gastos</h3>
              <table class="w-full text-sm">
                <thead class="text-left"><tr><th>Fecha</th><th>Categoria</th><th>Monto</th><th>Desc</th></tr></thead>
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
                <tbody id="tbGastos"></tbody>
              </table>
            </div>
          </div>
        </section>

<<<<<<< HEAD
        <!-- DEUDAS -->
        <section id="tab-deudas" class="tab hidden mt-4">
          <div class="grid md:grid-cols-2 gap-4">
            <form id="formDeuda" class="bg-white p-4 rounded shadow space-y-2">
              <h3 class="font-semibold text-lg">Nueva Deuda</h3>

              <select id="deudaTipo" class="w-full border rounded p-2">
                <option value="a_proveedor">A proveedor</option>
                <option value="de_la_empresa">De la empresa</option>
                <option value="personal_brandon">Personal Brandon</option>
                <option value="personal_socia">Personal Socia</option>
              </select>

              <!-- selector: quién debe (deudor) -->
              <label class="text-sm">Quién debe</label>
              <select id="deudaDeudor" class="w-full border rounded p-2">
                <option value="empresa">Empresa</option>
                <option value="brandon">Brandon</option>
                <option value="socia">Socia</option>
              </select>

              <!-- selector: a quién se debe (tipo acreedor) -->
              <label class="text-sm">A quién se le debe (tipo)</label>
              <select id="deudaAcreedorTipo" class="w-full border rounded p-2">
                <option value="proveedor">Proveedor</option>
                <option value="empresa">Empresa</option>
                <option value="brandon">Brandon</option>
                <option value="socia">Socia</option>
              </select>

              <input
                type="text"
                id="deudaAcreedor"
                placeholder="Acreedor/Descripción (nombre libre)"
                required
                class="w-full border rounded p-2"
              />

              <input
                type="number"
                id="deudaMonto"
                placeholder="Monto"
                step="0.01"
                min="0.01"
                required
                class="w-full border rounded p-2"
              />

              <textarea
                id="deudaNotas"
                placeholder="Notas"
                class="w-full border rounded p-2"
              ></textarea>

              <input type="hidden" id="editingDeudaId" value="" />

              <button
                type="submit"
                id="btnCrearDeuda"
                class="w-full bg-emerald-600 text-white py-2 rounded"
              >
                Crear Deuda
              </button>

              <p id="deudaMsg" class="text-sm text-slate-500"></p>
            </form>

            <div class="bg-white p-4 rounded shadow overflow-auto">
              <h3 class="font-semibold text-lg mb-2">Deudas</h3>
              <table class="w-full text-sm">
                <thead class="text-left">
                  <tr>
                    <th>Acreedor</th>
                    <th>Tipo</th>
                    <th>Saldo</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbDeudas"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- METAS -->
        <section id="tab-metas" class="tab hidden mt-4">
          <div class="grid md:grid-cols-2 gap-4">
            <form id="formMeta" class="bg-white p-4 rounded shadow space-y-2">
              <h3 class="font-semibold text-lg">Crear Meta</h3>
              <select id="metaTipo" class="w-full border rounded p-2">
                <option value="negocio">Negocio</option>
                <option value="brandon">Brandon</option>
                <option value="socia">Socia</option>
              </select>
              <input type="text" id="metaNombre" placeholder="Nombre de la meta" required class="w-full border rounded p-2">
              <input type="number" id="metaObjetivo" placeholder="Objetivo ($)" step="0.01" min="0" required class="w-full border rounded p-2">
              <textarea id="metaNotas" placeholder="Notas" class="w-full border rounded p-2"></textarea>
              <input type="hidden" id="editingMetaId" value="">
              <button class="w-full bg-emerald-600 text-white py-2 rounded">Crear Meta</button>
            </form>

            <div class="bg-white p-4 rounded shadow overflow-auto">
              <h3 class="font-semibold text-lg mb-2">Metas y Avance</h3>
              <table class="w-full text-sm">
                <thead class="text-left">
                  <tr>
                    <th>Meta</th><th>Tipo</th><th>Objetivo</th><th>Acumulado</th><th>%</th><th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbMetas"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- MOVIMIENTOS -->
        <section id="tab-movimientos" class="tab hidden mt-4">
          <div class="grid md:grid-cols-2 gap-4">
            <form id="formMovimiento" class="bg-white p-4 rounded shadow space-y-2">
              <h3 class="font-semibold text-lg">Nuevo Movimiento (ingreso/egreso/transferencia)</h3>
              <select id="movTipo" class="w-full border rounded p-2">
                <option value="ingreso">Ingreso</option>
                <option value="egreso">Egreso</option>
                <option value="transferencia">Transferencia</option>
              </select>

              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-sm">Cuenta Origen</label>
                  <select id="movCuenta" class="w-full border rounded p-2">
                    <option value="cajaEmpresa">Caja Empresa</option>
                    <option value="cajaBrandon">Caja Brandon</option>
                    <option value="cajaSocia">Caja Socia</option>
                    <option value="inversiones">Inversiones</option>
                    <option value="deudasTotales">Deudas Totales</option>
                  </select>
                </div>
                <div id="containerCuentaDestino" class="hidden">
                  <label class="text-sm">Cuenta Destino (solo transferencia)</label>
                  <select id="movCuentaDestino" class="w-full border rounded p-2">
                    <option value="cajaEmpresa">Caja Empresa</option>
                    <option value="cajaBrandon">Caja Brandon</option>
                    <option value="cajaSocia">Caja Socia</option>
                    <option value="inversiones">Inversiones</option>
                    <option value="deudasTotales">Deudas Totales</option>
                  </select>
                </div>
              </div>

              <input type="date" id="movFecha" class="w-full border rounded p-2">
              <input type="number" id="movMonto" placeholder="Monto" step="0.01" min="0" class="w-full border rounded p-2">
              <input type="text" id="movDesc" placeholder="Descripción" class="w-full border rounded p-2">
              <input type="hidden" id="editingMovId" value="">
              <button class="w-full bg-emerald-600 text-white py-2 rounded">Guardar Movimiento</button>
            </form>

            <div class="bg-white p-4 rounded shadow overflow-auto">
              <h3 class="font-semibold text-lg mb-2">Historial de Movimientos</h3>
              <table class="w-full text-sm">
                <thead class="text-left">
                  <tr>
                    <th>Fecha</th><th>Tipo</th><th>Cuenta(s)</th><th>Monto</th><th>Desc</th><th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbMovimientos"></tbody>
              </table>
            </div>
=======
        <section id="tab-deudas" class="tab hidden mt-4">
          <!-- Simplificado -->
          <div class="bg-white p-4 rounded shadow">
            <h3 class="font-semibold">Deudas</h3>
            <div id="deudasContainer" class="text-sm text-slate-600">Aquí se listarán las deudas si las usas.</div>
          </div>
        </section>

        <section id="tab-metas" class="tab hidden mt-4">
          <div class="bg-white p-4 rounded shadow">
            <h3 class="font-semibold">Metas</h3>
            <div id="metasContainer" class="text-sm text-slate-600">Metas y avance.</div>
          </div>
        </section>

        <section id="tab-movimientos" class="tab hidden mt-4">
          <div class="bg-white p-4 rounded shadow">
            <h3 class="font-semibold">Movimientos</h3>
            <div id="movimientosContainer" class="text-sm text-slate-600">Movimientos caja y contabilidad.</div>
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
          </div>
        </section>

        <!-- ESTADÍSTICAS -->
        <section id="tab-estadisticas" class="tab hidden mt-4">
          <div class="grid md:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded shadow" style="height:320px">
<<<<<<< HEAD
              <h3 class="font-semibold mb-2">Ingresos vs Gastos (últimos 90 días)</h3>
              <canvas id="chartIG" height="280"></canvas>
            </div>
            <div class="bg-white p-4 rounded shadow" style="height:320px">
              <h3 class="font-semibold mb-2">Utilidad y Margen por venta</h3>
              <canvas id="chartUtilidad" height="280"></canvas>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-4 mt-4">
            <div class="bg-white p-4 rounded shadow">
              <h3 class="font-semibold mb-2">Progreso Metas</h3>
              <div id="statsMetasList" class="space-y-2 text-sm"></div>
            </div>
            <div class="bg-white p-4 rounded shadow">
              <h3 class="font-semibold mb-2">Deudas - Saldo y avance</h3>
              <div id="statsDeudasList" class="space-y-2 text-sm"></div>
=======
              <h3 class="font-semibold mb-2">Top Productos (últimos 90 días)</h3>
              <canvas id="chartTopProducts" height="280"></canvas>
            </div>
            <div class="bg-white p-4 rounded shadow" style="height:320px">
              <h3 class="font-semibold mb-2">Ventas por día (últimos 30 días)</h3>
              <canvas id="chartVentasPorDia" height="280"></canvas>
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
            </div>
          </div>
        </section>

      </div>
    </div>
  </div>
<<<<<<< HEAD

    <!-- =========================
       SCRIPT: Firebase + Lógica (PARTE 2)
       ========================= -->
  <script type="module">
    // --------- FIREBASE CONFIG (usa el tuyo, aquí dejo el que ya usabas) ----------
    const firebaseConfig = {
=======
  <!--PARTE 1 FINAL-->

  <!-- =========================
     SCRIPT: Firebase + Lógica (COMPLETO y FINAL)
     ========================= -->
  <script type="module">
    /**************************************************************************
     * FIREBASE INIT
     * Cambia `firebaseConfig` por tus credenciales si quieres.
     **************************************************************************/
    const firebaseConfig = {
      // Puedes reemplazar por tu propio config si prefieres
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
      apiKey: "AIzaSyCTFSlLoKv6KKujTqjMeMjNc-AlKQ2-rng",
      authDomain: "duostyle01-611b9.firebaseapp.com",
      projectId: "duostyle01-611b9",
      storageBucket: "duostyle01-611b9.firebasestorage.app",
      messagingSenderId: "4630065257",
      appId: "1:4630065257:web:11b7b0a0ac2fa776bbf2f8",
      measurementId: "G-FW6QEJMZKT"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
<<<<<<< HEAD
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, addDoc, getDocs, onSnapshot, collection,
      query, orderBy, serverTimestamp, updateDoc, increment, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    window.db = db; window.auth = auth;
=======
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signOut, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    import {
      getFirestore, doc, setDoc, getDoc, addDoc, getDocs, onSnapshot,
      collection, query, orderBy, serverTimestamp, updateDoc, deleteDoc,
      runTransaction, where, limit
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // Nota: getDocs y where ya están disponibles vía import destructuring (getDocs es reexportado en la SDK)
    // Si tu entorno marca error con getDocs, reemplaza donde lo uso por getDocs (viene en el SDK usado).

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f

    // ---- Helpers UI
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
<<<<<<< HEAD
    const money = n => `$${Number(n||0).toLocaleString('es-CO', {maximumFractionDigits: 2})}`;

    // ---- State
    let currentUser = null;
    let companyId = null;
    let unsubscribers = [];

    // ---- Auth handlers
=======
    const money = n => `$${Number(n||0).toLocaleString('es-CO',{maximumFractionDigits:2})}`;

    // ---- State
    let currentUser = null;
    let companyId = null; // por ahora: `${user.uid}-company`
    let unsubscribers = [];
    let inventoryCache = new Map(); // productId => productData
    let salesCache = []; // quick local cache for charts

    /**************************************************************************
     * AUTH: login / register
     **************************************************************************/
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
    $("#loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = $("#loginEmail").value.trim();
      const pass = $("#loginPass").value.trim();
<<<<<<< HEAD
      await signInWithEmailAndPassword(auth, email, pass);
=======
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) {
        alert("Error login: " + err.message);
      }
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
    });

    $("#registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = $("#regName").value.trim();
      const email = $("#regEmail").value.trim();
      const pass = $("#regPass").value.trim();
<<<<<<< HEAD
      const ahorroPct = 0;

      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await updateProfile(cred.user, { displayName: name });
      await setDoc(doc(db, "users", cred.user.uid), { displayName: name, email, ahorroSugeridoPct: ahorroPct });

      // Crear company doc por defecto
      companyId = `${cred.user.uid}-company`;
      await setDoc(doc(db, "companies", companyId), {
        name: "Joyería — Empresa",
        owners: [{ uid: cred.user.uid, name }],
        mandatoryDebtPct: 0.10
      });
      await setDoc(doc(db, "companies", companyId, "state", "balances"), {
        cajaEmpresa: 0, cajaBrandon: 0, cajaSocia: 0, inversiones: 0, deudasTotales: 0
      });
=======
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: name });
        // crear user doc
        await setDoc(doc(db, "users", cred.user.uid), { displayName: name, email });
        // crear company por defecto (mismo patrón que tu repo)
        companyId = `${cred.user.uid}-company`;
        await setDoc(doc(db, "companies", companyId), {
          name: `${name} — Empresa`,
          owners: [{ uid: cred.user.uid, name }],
          createdAt: serverTimestamp()
        });
        // balances iniciales
        await setDoc(doc(db, "companies", companyId, "state", "balances"), {
          cajaEmpresa: 0, deudasTotales: 0
        });
      } catch (err) {
        alert("Error creating account: " + err.message);
      }
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
    });

    $("#btnLogout").addEventListener("click", () => signOut(auth));

<<<<<<< HEAD
    // ---- onAuth
=======
    /**************************************************************************
     * onAuthStateChanged: inicialización de la app cuando hay user
     **************************************************************************/
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      unsubscribers.forEach(u => u && u());
      unsubscribers = [];
<<<<<<< HEAD
=======
      inventoryCache.clear();

>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
      if (!user) {
        $("#authView").classList.remove("hidden");
        $("#mainView").classList.add("hidden");
        return;
      }
      $("#authView").classList.add("hidden");
      $("#mainView").classList.remove("hidden");

<<<<<<< HEAD
      companyId = `${user.uid}-company`;
      const compRef = doc(db, "companies", companyId);
      const snap = await getDoc(compRef);
      if (!snap.exists()) {
        await setDoc(compRef, {
          name: "Joyería — Empresa",
          owners: [{ uid: user.uid, name: user.displayName || "Owner" }],
          mandatoryDebtPct: 0.10
        });
        await setDoc(doc(db, "companies", companyId, "state", "balances"), {
          cajaEmpresa: 0, cajaBrandon: 0, cajaSocia: 0, inversiones: 0, deudasTotales: 0
=======
      // CompanyId simple (igual que tu repo): user.uid + '-company'
      companyId = `${user.uid}-company`;

      // Asegurar doc company exista
      const compRef = doc(db, "companies", companyId);
      const compSnap = await getDoc(compRef);
      if (!compSnap.exists()) {
        await setDoc(compRef, {
          name: "Empresa — Demo",
          owners: [{ uid: user.uid, name: user.displayName || "Owner" }],
          createdAt: serverTimestamp()
        });
        await setDoc(doc(db, "companies", companyId, "state", "balances"), {
          cajaEmpresa: 0, deudasTotales: 0
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
        });
      }
      $("#companyName").textContent = (await getDoc(compRef)).data().name;

<<<<<<< HEAD
      // Setup UI & subscriptions
      setupTabs();
      setupVentaFormHints();
      setupCharts();
      setupVentaToggle();
      setupPerfilButton();
      setupMovTipoToggle(); // mueve UI de transferencia

      subscribeKPIs();
      subscribeVentas();
      subscribeGastos();
      subscribeDeudas();
      subscribeMetas();
      subscribeMovimientos();

      // Listen to core collections to recompute balances
      const qSales = query(collection(db, "companies", companyId, "sales"), orderBy("createdAt","desc"));
      const qExp = query(collection(db, "companies", companyId, "expenses"), orderBy("createdAt","desc"));
      const qDeb = query(collection(db, "companies", companyId, "debts"), orderBy("createdAt","desc"));
      const qMov = query(collection(db, "companies", companyId, "movements"), orderBy("createdAt","desc"));
      const qGoals = query(collection(db, "companies", companyId, "goals"), orderBy("createdAt","desc"));

      unsubscribers.push(onSnapshot(qSales, () => recomputeBalances()));
      unsubscribers.push(onSnapshot(qExp, () => recomputeBalances()));
      unsubscribers.push(onSnapshot(qDeb, () => recomputeBalances()));
      unsubscribers.push(onSnapshot(qMov, () => recomputeBalances()));
      unsubscribers.push(onSnapshot(qGoals, () => recomputeBalances()));

      await recomputeBalances();
    });

    // ---- Tabs
=======
      // Setup UI
      setupTabs();
      setupInventoryHandlers();
      setupPosHandlers();
      setupCharts();
      setupCajaControls(); // <<< importante: engancha controles de caja

      // Subscriptions en tiempo real:
      subscribeInventory();
      subscribeSales();
      subscribeBalances(); // KPI

      // Initial load for charts etc
      await loadSalesOnce();
    });

    /**************************************************************************
     * Tabs UI
     **************************************************************************/
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
    function setupTabs() {
      $$(".tab-btn").forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.tab;
          $$(".tab-btn").forEach(b => b.classList.remove("bg-slate-900","text-white"));
          btn.classList.add("bg-slate-900","text-white");
          $$(".tab").forEach(t => t.classList.add("hidden"));
          $(`#tab-${id}`).classList.remove("hidden");
        };
      });
<<<<<<< HEAD
    }

    // ---- KPIs (subscribe balances doc)
    function subscribeKPIs() {
      const ref = doc(db, "companies", companyId, "state", "balances");
      const unsub = onSnapshot(ref, snap => {
        const d = snap.exists() ? snap.data() : { cajaEmpresa:0, cajaBrandon:0, cajaSocia:0, deudasTotales:0 };
        $("#kpiCajaEmpresa").textContent = money(d.cajaEmpresa);
        $("#kpiCajaBrandon").textContent = money(d.cajaBrandon);
        $("#kpiCajaSocia").textContent = money(d.cajaSocia);
        $("#kpiDeudas").textContent = money(d.deudasTotales);
=======
      // activar ventas por defecto
      $("[data-tab='ventas']").click();
    }

    /**************************************************************************
     * SUBSCRIBE / INVENTORY
     *
     * Collections structure:
     * companies/{companyId}/inventory/{productId} -> product doc with:
     *   { name, sku, attributes: {size,color,gender,team}, price, cost, stock, notes, createdAt }
     *
     * companies/{companyId}/inventory/{productId}/batches/{batchId} -> batch entries
     * companies/{companyId}/stock_movements/{movementId} -> audit log: { productId, qty, type: 'in'|'out', refId, createdAt }
     **************************************************************************/

    // escucha en tiempo real inventario
    function subscribeInventory() {
      const invCol = collection(db, "companies", companyId, "inventory");
      const q = query(invCol, orderBy("name"));
      const unsub = onSnapshot(q, snap => {
        snap.docChanges().forEach(ch => {
          const id = ch.doc.id;
          const data = { id, ...ch.doc.data() };
          if (ch.type === "removed") inventoryCache.delete(id);
          else inventoryCache.set(id, data);
        });
        renderInventoryTable();
        populateProductSelects(); // actualizar selects del POS
        // actualizar KPI de inventario total
        updateInventarioKPI();
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
      });
      unsubscribers.push(unsub);
    }

<<<<<<< HEAD
    // ------------------------------------------------
    // computePaidBy: decide quién pagó el costo y crear movs si needed
    // ------------------------------------------------
    async function computePaidBy(financiadoPor, amount, createMovements = false) {
      try {
        const balSnap = await getDoc(doc(db, "companies", companyId, "state", "balances"));
        const balances = balSnap.exists() ? balSnap.data() : { cajaEmpresa:0, cajaBrandon:0, cajaSocia:0 };
        const empresaCaja = Number(balances.cajaEmpresa || 0);

        let pb = { empresa: 0, brandon: 0, socia: 0 };

        if (financiadoPor === "brandon") {
          pb.brandon = Number(amount);
        } else if (financiadoPor === "socia") {
          pb.socia = Number(amount);
        } else {
          if (empresaCaja >= amount) {
            pb.empresa = Number(amount);
          } else {
            pb.empresa = Number(Math.max(0, empresaCaja).toFixed(2));
            const shortage = Number((amount - pb.empresa).toFixed(2));
            const half = Number((shortage/2).toFixed(2));
            pb.brandon = half;
            pb.socia = half;
            const remainder = Number((shortage - (half*2)).toFixed(2));
            if (remainder !== 0) pb.brandon = Number((pb.brandon + remainder).toFixed(2));
          }
        }

        if (createMovements) {
          const moves = [];
          const today = new Date().toISOString().slice(0,10);
          if (pb.brandon && pb.brandon > 0) {
            moves.push(addDoc(collection(db, "companies", companyId, "movements"), {
              tipo: "egreso",
              cuenta: "cajaBrandon",
              fecha: today,
              monto: pb.brandon,
              desc: `Anticipo de Brandon para costo (${financiadoPor})`,
              createdAt: serverTimestamp()
            }));
          }
          if (pb.socia && pb.socia > 0) {
            moves.push(addDoc(collection(db, "companies", companyId, "movements"), {
              tipo: "egreso",
              cuenta: "cajaSocia",
              fecha: today,
              monto: pb.socia,
              desc: `Anticipo de Socia para costo (${financiadoPor})`,
              createdAt: serverTimestamp()
            }));
          }
          if (moves.length) await Promise.all(moves);
        }

        return pb;
      } catch (err) {
        console.error("computePaidBy error:", err);
        const half = Number((amount/2).toFixed(2));
        return { empresa: 0, brandon: half, socia: half };
      }
    }

    // ------------------------------------------------
    // recomputeBalances: recalcula todo desde cero (movimientos, ventas, gastos, deudas, metas)
    // ------------------------------------------------


    async function recomputeBalances() {
  try {
    // base
    const base = { cajaEmpresa: 0, cajaBrandon: 0, cajaSocia: 0, inversiones: 0, deudasTotales: 0 };
    const num = v => Number(v || 0);

    // 1) Movements (ingreso / egreso / transferencia)
    const movSnap = await getDocs(collection(db, "companies", companyId, "movements"));
    movSnap.forEach(snap => {
      const m = snap.data();
      const monto = num(m.monto);

      if (m.tipo === "ingreso") {
        if (m.cuenta === "cajaEmpresa") base.cajaEmpresa += monto;
        if (m.cuenta === "cajaBrandon") base.cajaBrandon += monto;
        if (m.cuenta === "cajaSocia") base.cajaSocia += monto;
        if (m.cuenta === "inversiones") base.inversiones += monto;
        if (m.cuenta === "deudasTotales") base.deudasTotales += monto;
      } else if (m.tipo === "egreso") {
        if (m.cuenta === "cajaEmpresa") base.cajaEmpresa -= monto;
        if (m.cuenta === "cajaBrandon") base.cajaBrandon -= monto;
        if (m.cuenta === "cajaSocia") base.cajaSocia -= monto;
        if (m.cuenta === "inversiones") base.inversiones -= monto;
        if (m.cuenta === "deudasTotales") base.deudasTotales -= monto;
      } else if (m.tipo === "transferencia") {
        // resta en origen, suma en destino
        const origen = m.cuenta;
        const destino = m.cuentaDestino;
        if (origen === "cajaEmpresa") base.cajaEmpresa -= monto;
        if (origen === "cajaBrandon") base.cajaBrandon -= monto;
        if (origen === "cajaSocia") base.cajaSocia -= monto;
        if (origen === "inversiones") base.inversiones -= monto;
        if (origen === "deudasTotales") base.deudasTotales -= monto;

        if (destino === "cajaEmpresa") base.cajaEmpresa += monto;
        if (destino === "cajaBrandon") base.cajaBrandon += monto;
        if (destino === "cajaSocia") base.cajaSocia += monto;
        if (destino === "inversiones") base.inversiones += monto;
        if (destino === "deudasTotales") base.deudasTotales += monto;
      }
    });

    // 2) Sales: manejamos varios esquemas de documento (compatibilidad)
    const salesSnap = await getDocs(collection(db, "companies", companyId, "sales"));
    salesSnap.forEach(snap => {
      const s = snap.data();

      // soporta: precio/costo (antiguo) o monto/inversion (nuevo)
      const price = num(s.precio ?? s.monto ?? s.price);
      const cost = num(s.costo ?? s.inversion ?? s.cost);
      const utilidad = num(s.utilidad ?? (price - cost));
      const asign = s.asignaciones || {};

      // derive paidBy: prefer asignaciones.paidBy, luego asignaciones.financiadoPor, luego root.financiadoPor
      let pb = { empresa: 0, brandon: 0, socia: 0 };
      if (asign && asign.paidBy) {
        pb.empresa = num(asign.paidBy.empresa);
        pb.brandon = num(asign.paidBy.brandon);
        pb.socia = num(asign.paidBy.socia);
      } else {
        const fp = asign.financiadoPor || s.financiadoPor || "empresa";
        if (fp === "brandon") pb.brandon = cost;
        else if (fp === "socia") pb.socia = cost;
        else pb.empresa = cost;
      }

      // Si el usuario usó modo manual, respetamos los campos manuales (reinversion, brandon, socia, pagoDeuda)
      if (asign.manualMode) {
        if (asign.reinversion) base.inversiones += num(asign.reinversion);
        if (asign.brandon) base.cajaBrandon += num(asign.brandon);
        if (asign.socia) base.cajaSocia += num(asign.socia);
        if (asign.pagoDeuda) base.deudasTotales -= num(asign.pagoDeuda);
      } else {
        // Reembolsos a quienes adelantaron el costo (solo a Brand./Socia)
        if (pb.brandon && pb.brandon > 0) base.cajaBrandon += num(pb.brandon);
        if (pb.socia && pb.socia > 0) base.cajaSocia += num(pb.socia);
        // NOTA: si pb.empresa > 0, no "devolvemos" la inversión a la empresa (evita doble conteo).
        // Reparto de utilidad 50/50
        if (utilidad > 0) {
          const halfU = Number((utilidad / 2).toFixed(2));
          base.cajaBrandon += halfU;
          base.cajaSocia += halfU;
        }
        // reinversion / pagoDeuda opcionales
        if (asign.reinversion) base.inversiones += num(asign.reinversion);
        if (asign.pagoDeuda) base.deudasTotales -= num(asign.pagoDeuda);
      }
    });

    // 3) Expenses
    const expSnap = await getDocs(collection(db, "companies", companyId, "expenses"));
    expSnap.forEach(snap => {
      const g = snap.data();
      const monto = num(g.monto);
      if (g.paidDistribution) {
        base.cajaEmpresa -= num(g.paidDistribution.empresa || 0);
        base.cajaBrandon -= num(g.paidDistribution.brandon || 0);
        base.cajaSocia -= num(g.paidDistribution.socia || 0);
      } else {
        if (g.pagadoPor === "empresa") base.cajaEmpresa -= monto;
        if (g.pagadoPor === "brandon") base.cajaBrandon -= monto;
        if (g.pagadoPor === "socia") base.cajaSocia -= monto;
      }
    });

    // 4) Debts
    const debtsSnap = await getDocs(collection(db, "companies", companyId, "debts"));
    debtsSnap.forEach(snap => {
      const d = snap.data();
      const saldo = num(d.saldo ?? d.montoInicial);
      base.deudasTotales += saldo;
    });

    // 5) Goals
    const goalsSnap = await getDocs(collection(db, "companies", companyId, "goals"));
    goalsSnap.forEach(snap => {
      const g = snap.data();
      const acum = num(g.acumulado);
      if (g.tipo === "negocio") base.cajaEmpresa -= acum;
      if (g.tipo === "brandon") base.cajaBrandon -= acum;
      if (g.tipo === "socia") base.cajaSocia -= acum;
    });

    // normalizar floats
    for (let k of Object.keys(base)) base[k] = Number(base[k].toFixed(2));

    // evitar cajaEmpresa negativa: repartir déficit 50/50 entre Brandon y Socia
    if (base.cajaEmpresa < 0) {
      const deficit = -base.cajaEmpresa;
      base.cajaEmpresa = 0;
      const halfDef = Number((deficit / 2).toFixed(2));
      base.cajaBrandon -= halfDef;
      base.cajaSocia -= halfDef;
    }

    // guardar balances absolutos
    await setDoc(doc(db, "companies", companyId, "state", "balances"), base, { merge: true });

  } catch (err) {
    console.error("recomputeBalances error:", err);
=======

// eliminar venta
        // ELIMINAR VENTA
   async function deleteSale(ventaId) {
  try {
    await runTransaction(db, async (tx) => {
      const ventaRef = doc(db, "companies", companyId, "sales", ventaId);
      const ventaSnap = await tx.get(ventaRef);
      if (!ventaSnap.exists()) throw "Venta no existe";
      const venta = ventaSnap.data();

      // Leer balances
      const balancesRef = doc(db, "companies", companyId, "state", "balances");
      const balancesSnap = await tx.get(balancesRef);
      const balances = balancesSnap.data();

      // Leer todos los productos primero
      const productos = [];
      for (let item of venta.items) {
        const prodRef = doc(db, "companies", companyId, "inventory", item.productId);
        const prodSnap = await tx.get(prodRef);
        if (prodSnap.exists()) {
          productos.push({ ref: prodRef, data: prodSnap.data(), item });
        }
      }

      // --- Ahora sí: solo escrituras ---
      // 1. Actualizar balances
      tx.update(balancesRef, {
        cajaEmpresa: (balances.cajaEmpresa || 0) - venta.total
      });

      // 2. Reponer stock
      for (let { ref, data, item } of productos) {
        tx.update(ref, {
          stock: (data.stock || 0) + item.qty
        });
      }

      // 3. Eliminar venta
      tx.delete(ventaRef);
    });

    alert("Venta eliminada y balances/stock actualizados ✅");
  } catch (err) {
    console.error("Error al eliminar venta:", err);
    alert("Error al eliminar venta: " + err);
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
  }
}



<<<<<<< HEAD
    // small helper: adjustBalances incremental (kept for rare direct ops)
    async function adjustBalances({ cajaEmpresa=0, cajaBrandon=0, cajaSocia=0, deudasTotales=0, inversiones=0 }) {
      await setDoc(doc(db, "companies", companyId, "state", "balances"), {
        cajaEmpresa: increment(cajaEmpresa),
        cajaBrandon: increment(cajaBrandon),
        cajaSocia: increment(cajaSocia),
        deudasTotales: increment(deudasTotales),
        inversiones: increment(inversiones)
      }, { merge: true });
    }

    // ---------------------------
    // VENTAS (submit)
    // ---------------------------
    function setupVentaFormHints() {
      const costo = $("#ventaCosto");
      const precio = $("#ventaPrecio");
      async function updateResumen() {
        const c = Number(costo.value||0), p = Number(precio.value||0);
        const util = p - c;
        const margen = p ? (util / p) : 0;
        $("#ventaResumen").textContent = `Utilidad: ${money(util)} (${(margen*100).toFixed(1)}%)`;
        try {
          const snap = await getDoc(doc(db, "users", currentUser.uid));
          const pct = (snap.exists() ? (snap.data().ahorroSugeridoPct || 0) : 0);
          const asigB = Number($("#asigBrandon").value||0);
          const sug = asigB * pct;
          $("#sugerenciaAhorro").textContent = pct ? `Sugerencia: aparta ${money(sug)} (${(pct*100).toFixed(0)}% de lo asignado a Brandon) hacia ahorros.` : "";
        } catch (err) {
          $("#sugerenciaAhorro").textContent = "";
        }
      }
      ["input","change"].forEach(ev => {
        costo.addEventListener(ev, updateResumen);
        precio.addEventListener(ev, updateResumen);
        $("#asigBrandon").addEventListener(ev, updateResumen);
      });
    }

    function setupVentaToggle() {
      $("#ventaManualToggle").addEventListener("change", () => {
        const on = $("#ventaManualToggle").checked;
        if (on) {
          $("#manualDistribFields").classList.remove("hidden");
          $("#autoDistribNote").classList.add("hidden");
        } else {
          $("#manualDistribFields").classList.add("hidden");
          $("#autoDistribNote").classList.remove("hidden");
          // limpiar
          $("#asigReinv").value = "";
          $("#asigBrandon").value = "";
          $("#asigSocia").value = "";
          $("#asigPagoDeuda").value = "";
        }
      });
    }

    // ---------------------------
    // MOVIMIENTOS: UI toggle para transferencia
    // ---------------------------
    function setupMovTipoToggle() {
      const movTipo = $("#movTipo");
      const contDest = $("#containerCuentaDestino");
      movTipo.addEventListener("change", () => {
        if (movTipo.value === "transferencia") contDest.classList.remove("hidden");
        else contDest.classList.add("hidden");
      });
      // inicial
      if (movTipo.value === "transferencia") contDest.classList.remove("hidden");
      else contDest.classList.add("hidden");
    }

    // ---------------------------
    // FORM SUBMITS: VENTA / GASTO / DEUDA / META / MOVIMIENTO

    
    // ---------------------------
   $("#formVenta").addEventListener("submit", async (e) => {
  e.preventDefault();
  const editingId = $("#editingSaleId").value || "";
  const date = $("#ventaFecha").value || new Date().toISOString().slice(0,10);
  const producto = $("#ventaProducto").value.trim();
  const costo = Number($("#ventaCosto").value||0);
  const precio = Number($("#ventaPrecio").value||0);
  const notas = $("#ventaNotas").value.trim();
  const utilidad = precio - costo;
  const margen = precio ? utilidad / precio : 0;
  const financiadoPor = $("#ventaFinanciadaPor").value;
  const manualMode = $("#ventaManualToggle").checked;

  const asig = {
    manualMode,
    financiadoPor,
    reinversion: Number($("#asigReinv").value||0),
    brandon: Number($("#asigBrandon").value||0),
    socia: Number($("#asigSocia").value||0),
    pagoDeuda: Number($("#asigPagoDeuda").value||0)
  };

  if (precio <= 0) { alert("El precio debe ser mayor a 0"); return; }
  if (costo < 0) { alert("El costo no puede ser negativo"); return; }

  // --- compute paidBy (crea movimientos si corresponde) ---
  const createMovs = !editingId;
  let paidBy = await computePaidBy(financiadoPor, costo, createMovs);

  // Si la inversión la hizo la EMPRESA NO devolvemos el costo como reembolso a la empresa (evita duplicado)
  if (financiadoPor === "empresa") {
    paidBy = { empresa: 0, brandon: 0, socia: 0 };
  }
  asig.paidBy = paidBy;

  // Estructura del documento: guardamos campos compatibles
  const payload = {
    date, producto,
    costo, precio,
    utilidad, margen,
    notas,
    asignaciones: asig,
    // campos adicionales para compatibilidad con variantes que uses
    monto: precio,
    inversion: costo,
    financiadoPor,
    updatedAt: serverTimestamp()
  };

  if (editingId) {
    await updateDoc(doc(db, "companies", companyId, "sales", editingId), payload);
    $("#editingSaleId").value = "";
  } else {
    payload.createdAt = serverTimestamp();
    await addDoc(collection(db, "companies", companyId, "sales"), payload);
  }

  // recompute balances robustly after operation
  await recomputeBalances();

  e.target.reset();
  $("#manualDistribFields").classList.add("hidden");
  $("#autoDistribNote").classList.remove("hidden");
});


    // GASTOS
    $("#formGasto").addEventListener("submit", async (e) => {
      e.preventDefault();
      const editingId = $("#editingGastoId").value || "";
      const date = $("#gastoFecha").value || new Date().toISOString().slice(0,10);
      const categoria = $("#gastoCat").value.trim();
      const monto = Number($("#gastoMonto").value||0);
      const descripcion = $("#gastoDesc").value.trim();
      const pagadoPor = $("#gastoPagadoPor").value;

      const createMovs = !editingId;
      const paidDistribution = await computePaidBy(pagadoPor, monto, createMovs);

      if (editingId) {
        await updateDoc(doc(db, "companies", companyId, "expenses", editingId), {
          date, categoria, monto, descripcion, pagadoPor, paidDistribution, updatedAt: serverTimestamp()
        });
        $("#editingGastoId").value = "";
      } else {
        await addDoc(collection(db, "companies", companyId, "expenses"), {
          date, categoria, monto, descripcion, pagadoPor, paidDistribution, createdAt: serverTimestamp()
        });
      }

      await recomputeBalances();
      e.target.reset();
    });

    // DEUDAS (submit) - ahora con deudor y tipo acreedor
    $("#formDeuda").addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = $("#btnCrearDeuda");
      btn.disabled = true;
      const originalText = btn.textContent;
      btn.textContent = "Guardando...";

      try {
        const editingId = $("#editingDeudaId").value || "";
        const tipo = $("#deudaTipo").value;
        const deudor = $("#deudaDeudor").value || "empresa";
        const acreedorTipo = $("#deudaAcreedorTipo").value || "proveedor";
        const acreedorTexto = $("#deudaAcreedor").value.trim();
        const monto = Number($("#deudaMonto").value||0);
        const notas = $("#deudaNotas").value.trim();

        if (!acreedorTexto) throw new Error("Ingresa el acreedor/descripcion.");
        if (isNaN(monto) || monto <= 0) throw new Error("El monto debe ser mayor a 0.");

        const payload = {
          tipo,
          deudor,
          acreedorTipo,
          acreedor: acreedorTexto,
          montoInicial: monto,
          saldo: monto,
          notas,
          updatedAt: serverTimestamp(),
        };

        if (editingId) {
          await updateDoc(doc(db, "companies", companyId, "debts", editingId), payload);
          $("#editingDeudaId").value = "";
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db, "companies", companyId, "debts"), payload);
        }

        await recomputeBalances();
        $("#formDeuda").reset();
        $("#deudaMsg").textContent = "Deuda guardada correctamente.";
        setTimeout(() => ($("#deudaMsg").textContent = ""), 2500);
      } catch (err) {
        console.error("Guardar deuda:", err);
        alert("No se pudo guardar la deuda: " + (err.message || err));
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });

    // METAS
    $("#formMeta").addEventListener("submit", async (e) => {
      e.preventDefault();
      const editingId = $("#editingMetaId").value || "";
      const tipo = $("#metaTipo").value;
      const nombre = $("#metaNombre").value.trim();
      const objetivoMonto = Number($("#metaObjetivo").value||0);
      const notas = $("#metaNotas").value.trim();

      if (editingId) {
        await updateDoc(doc(db, "companies", companyId, "goals", editingId), {
          tipo, nombre, objetivoMonto, updatedAt: serverTimestamp()
        });
        $("#editingMetaId").value = "";
      } else {
        await addDoc(collection(db, "companies", companyId, "goals"), {
          tipo, nombre, objetivoMonto, acumulado: 0, notas, createdAt: serverTimestamp()
        });
      }

      await recomputeBalances();
      e.target.reset();
    });

    // MOVIMIENTOS (submit) soportando transferencia con cuentaDestino
    $("#formMovimiento").addEventListener("submit", async (e) => {
      e.preventDefault();
      const editingId = $("#editingMovId").value || "";
      const tipo = $("#movTipo").value;
      const cuenta = $("#movCuenta").value;
      const cuentaDestino = $("#movCuentaDestino") ? $("#movCuentaDestino").value : "";
      const fecha = $("#movFecha").value || new Date().toISOString().slice(0,10);
      const monto = Number($("#movMonto").value||0);
      const desc = $("#movDesc").value || "";

      if (monto <= 0) { alert("Monto debe ser mayor que 0"); return; }

      const payload = { tipo, cuenta, fecha, monto, desc, updatedAt: serverTimestamp() };
      if (tipo === "transferencia") payload.cuentaDestino = cuentaDestino;

      if (editingId) {
        await updateDoc(doc(db, "companies", companyId, "movements", editingId), payload);
        $("#editingMovId").value = "";
      } else {
        payload.createdAt = serverTimestamp();
        await addDoc(collection(db, "companies", companyId, "movements"), payload);
      }

      await recomputeBalances();
      e.target.reset();
      // reset UI
      setupMovTipoToggle();
    });

    // ---------------------------
    // SUBSCRIPTIONS: VENTAS / GASTOS / DEUDAS / METAS / MOVIMIENTOS
    // ---------------------------
    function subscribeVentas() {
      const qSales = query(collection(db, "companies", companyId, "sales"), orderBy("createdAt","desc"));
      const unsub = onSnapshot(qSales, (snap) => {
        const tbody = $("#tbVentas"); tbody.innerHTML = "";
        snap.forEach(docu => {
          const s = docu.data(); const id = docu.id;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${s.date}</td>
            <td>${s.producto}</td>
            <td>${money(s.precio)}</td>
            <td>${money(s.costo)}</td>
            <td>${money(s.utilidad)}</td>
            <td>${(s.margen*100).toFixed(1)}%</td>
            <td>
              <button data-id="${id}" class="edit-sale text-blue-600 underline mr-2">Editar</button>
              <button data-id="${id}" class="del-sale text-red-600 underline">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        $$(".del-sale").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            if (!confirm("Eliminar venta? Esto recalculará balances.")) return;
            await deleteDoc(doc(db, "companies", companyId, "sales", id));
            await recomputeBalances();
          };
        });

        $$(".edit-sale").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const ref = doc(db, "companies", companyId, "sales", id);
            const snap = await getDoc(ref);
            if (!snap.exists()) return alert("Documento no encontrado.");
            const data = snap.data();
            $("#editingSaleId").value = id;
            $("#ventaFecha").value = data.date || "";
            $("#ventaProducto").value = data.producto || "";
            $("#ventaCosto").value = data.costo || "";
            $("#ventaPrecio").value = data.precio || "";
            $("#ventaNotas").value = data.notas || "";
            const a = data.asignaciones || {};
            $("#ventaFinanciadaPor").value = a.financiadoPor || "empresa";
            $("#ventaManualToggle").checked = !!a.manualMode;
            if (a.manualMode) {
              $("#manualDistribFields").classList.remove("hidden"); $("#autoDistribNote").classList.add("hidden");
              $("#asigReinv").value = a.reinversion || ""; $("#asigBrandon").value = a.brandon || "";
              $("#asigSocia").value = a.socia || ""; $("#asigPagoDeuda").value = a.pagoDeuda || "";
            } else {
              $("#manualDistribFields").classList.add("hidden"); $("#autoDistribNote").classList.remove("hidden");
              $("#asigReinv").value = a.reinversion || ""; $("#asigPagoDeuda").value = a.pagoDeuda || "";
              $("#asigBrandon").value = ""; $("#asigSocia").value = "";
            }
            document.querySelector('[data-tab="ventas"]').click();
          };
        });

        refreshCharts();
      });
      unsubscribers.push(unsub);
    }

    function subscribeGastos() {
      const qExp = query(collection(db, "companies", companyId, "expenses"), orderBy("createdAt","desc"));
      const unsub = onSnapshot(qExp, (snap) => {
        const tbody = $("#tbGastos"); tbody.innerHTML = "";
        snap.forEach(docu => {
          const g = docu.data(); const id = docu.id;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${g.date}</td><td>${g.categoria}</td><td>${money(g.monto)}</td><td>${g.pagadoPor}</td><td>${g.descripcion||""}</td>
            <td>
              <button data-id="${id}" class="edit-gasto text-blue-600 underline mr-2">Editar</button>
              <button data-id="${id}" class="del-gasto text-red-600 underline">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        $$(".del-gasto").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            if (!confirm("Eliminar gasto? Esto recalculará balances.")) return;
            await deleteDoc(doc(db, "companies", companyId, "expenses", id));
            await recomputeBalances();
          };
        });

        $$(".edit-gasto").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const snap = await getDoc(doc(db, "companies", companyId, "expenses", id));
            if (!snap.exists()) return;
            const g = snap.data();
            $("#editingGastoId").value = id;
            $("#gastoFecha").value = g.date || "";
            $("#gastoCat").value = g.categoria || "";
            $("#gastoMonto").value = g.monto || "";
            $("#gastoDesc").value = g.descripcion || "";
            $("#gastoPagadoPor").value = g.pagadoPor || "empresa";
            document.querySelector('[data-tab="gastos"]').click();
          };
        });

        refreshCharts();
      });
      unsubscribers.push(unsub);
    }

    function subscribeDeudas() {
      const qDeb = query(collection(db, "companies", companyId, "debts"), orderBy("createdAt","desc"));
      const unsub = onSnapshot(qDeb, (snap) => {
        const tbody = $("#tbDeudas"); tbody.innerHTML = "";
        snap.forEach(docu => {
          const d = docu.data(); const id = docu.id;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.acreedor} (${d.acreedorTipo || ''})</td><td>${d.tipo}</td><td>${money(d.saldo)}</td>
            <td>
              <input type="number" step="0.01" min="0" placeholder="Abono" class="border rounded p-1 w-28" id="abono-${id}">
              <button data-id="${id}" class="btn-abonar text-emerald-700 underline ml-1">Abonar</button>
              <button data-id="${id}" class="edit-deuda text-blue-600 underline ml-2">Editar</button>
              <button data-id="${id}" class="del-deuda text-red-600 underline ml-2">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        $$(".btn-abonar").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const ab = Number($(`#abono-${id}`).value||0);
            if (ab <= 0) return;
            const ref = doc(db, "companies", companyId, "debts", id);
            const snap = await getDoc(ref);
            const saldo = (snap.data().saldo || 0) - ab;
            await updateDoc(ref, { saldo: Math.max(0, saldo), updatedAt: serverTimestamp() });
            await recomputeBalances();
            $(`#abono-${id}`).value = "";
          };
        });

        $$(".del-deuda").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            if (!confirm("Eliminar deuda? Esto recalculará balances.")) return;
            await deleteDoc(doc(db, "companies", companyId, "debts", id));
            await recomputeBalances();
          };
        });

        $$(".edit-deuda").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const snap = await getDoc(doc(db, "companies", companyId, "debts", id));
            if (!snap.exists()) return;
            const d = snap.data();
            $("#editingDeudaId").value = id;
            $("#deudaTipo").value = d.tipo || "a_proveedor";
            $("#deudaDeudor").value = d.deudor || "empresa";
            $("#deudaAcreedorTipo").value = d.acreedorTipo || "proveedor";
            $("#deudaAcreedor").value = d.acreedor || "";
            $("#deudaMonto").value = d.montoInicial || "";
            $("#deudaNotas").value = d.notas || "";
            document.querySelector('[data-tab="deudas"]').click();
          };
        });

      });
      unsubscribers.push(unsub);
    }

    function subscribeMetas() {
      const qGoals = query(collection(db, "companies", companyId, "goals"), orderBy("createdAt","desc"));
      const unsub = onSnapshot(qGoals, (snap) => {
        const tbody = $("#tbMetas"); tbody.innerHTML = "";
        snap.forEach(docu => {
          const g = docu.data(); const id = docu.id;
          const pct = g.objetivoMonto ? (g.acumulado/g.objetivoMonto)*100 : 0;
          const faltante = Math.max(0, (g.objetivoMonto || 0) - (g.acumulado || 0));
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${g.nombre}</td><td>${g.tipo}</td><td>${money(g.objetivoMonto)}</td><td>${money(g.acumulado)}</td><td>${pct.toFixed(0)}%</td>
            <td>
              <input type="number" step="0.01" min="0" placeholder="$" class="border rounded p-1 w-24" id="abmeta-${id}">
              <button data-id="${id}" class="btn-abonar-meta text-emerald-700 underline ml-1">Abonar</button>
              <button data-id="${id}" class="edit-meta text-blue-600 underline ml-2">Editar</button>
              <button data-id="${id}" class="del-meta text-red-600 underline ml-2">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        $$(".btn-abonar-meta").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const ab = Number($(`#abmeta-${id}`).value||0);
            if (ab <= 0) return;
            const ref = doc(db, "companies", companyId, "goals", id);
            const snap = await getDoc(ref);
            const acum = (snap.data().acumulado || 0) + ab;
            await updateDoc(ref, { acumulado: acum, updatedAt: serverTimestamp() });
            await recomputeBalances();
            $(`#abmeta-${id}`).value = "";
          };
        });

        $$(".del-meta").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            if (!confirm("Eliminar meta?")) return;
            await deleteDoc(doc(db, "companies", companyId, "goals", id));
            await recomputeBalances();
          };
        });

        $$(".edit-meta").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const snap = await getDoc(doc(db, "companies", companyId, "goals", id));
            if (!snap.exists()) return;
            const g = snap.data();
            $("#editingMetaId").value = id;
            $("#metaTipo").value = g.tipo || "negocio";
            $("#metaNombre").value = g.nombre || "";
            $("#metaObjetivo").value = g.objetivoMonto || "";
            $("#metaNotas").value = g.notas || "";
            document.querySelector('[data-tab="metas"]').click();
          };
        });

      });
      unsubscribers.push(unsub);
    }

    // Movimientos
    function subscribeMovimientos() {
      const q = query(collection(db, "companies", companyId, "movements"), orderBy("createdAt","desc"));
      const unsub = onSnapshot(q, snap => {
        const tbody = $("#tbMovimientos"); tbody.innerHTML = "";
        snap.forEach(docu => {
          const m = docu.data(); const id = docu.id;
          let cuentasTxt = m.cuenta;
          if (m.tipo === "transferencia" && m.cuentaDestino) {
            cuentasTxt = `${m.cuenta} → ${m.cuentaDestino}`;
          }

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${m.fecha}</td>
            <td>${m.tipo}</td>
            <td>${cuentasTxt}</td>
            <td>${money(m.monto)}</td>
            <td>${m.desc||""}</td>
            <td>
              <button data-id="${id}" class="edit-mov text-blue-600 underline mr-2">Editar</button>
              <button data-id="${id}" class="del-mov text-red-600 underline">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        $$(".del-mov").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            if (!confirm("Eliminar movimiento? Esto recalculará balances.")) return;
            await deleteDoc(doc(db, "companies", companyId, "movements", id));
            await recomputeBalances();
          };
        });

        $$(".edit-mov").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const snap = await getDoc(doc(db, "companies", companyId, "movements", id));
            if (!snap.exists()) return;
            const m = snap.data();
            $("#editingMovId").value = id;
            $("#movTipo").value = m.tipo || "ingreso";
            $("#movCuenta").value = m.cuenta || "cajaEmpresa";
            if (m.tipo === "transferencia" && m.cuentaDestino) {
              $("#movCuentaDestino").value = m.cuentaDestino;
              $("#containerCuentaDestino").classList.remove("hidden");
            } else {
              $("#containerCuentaDestino").classList.add("hidden");
            }
            $("#movFecha").value = m.fecha || "";
            $("#movMonto").value = m.monto || "";
            $("#movDesc").value = m.desc || "";
            document.querySelector('[data-tab="movimientos"]').click();
          };
        });
=======

    // carga inicial de ventas/sales solo 1 vez para charts
    async function loadSalesOnce() {
      try {
        const q = query(collection(db, "companies", companyId, "sales"), orderBy("createdAt"));
        const docs = await getDocs(q);
        salesCache = docs.docs.map(d => ({ id: d.id, ...d.data() }));
        renderSalesTable();
        updateCharts();
      } catch (err) {
        console.error("loadSalesOnce", err);
      }
    }

    // subscription ventas (para lista en tiempo real)
    function subscribeSales() {
      const salesCol = collection(db, "companies", companyId, "sales");
      const q = query(salesCol, orderBy("createdAt", "desc"));
      const unsub = onSnapshot(q, snap => {
        salesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderSalesTable();
        updateCharts();
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
      });
      unsubscribers.push(unsub);
    }

<<<<<<< HEAD
    // ------------------------------------------------
    // GRÁFICAS (Chart.js) y estadísticas adicionales
    // ------------------------------------------------
    let chartIG = null, chartUtilidad = null;
    function setupCharts() {
      try { if (chartIG) chartIG.destroy(); } catch(e){}
      try { if (chartUtilidad) chartUtilidad.destroy(); } catch(e){}

      chartIG = new Chart($("#chartIG"), {
        type: 'line',
        data: { labels: [], datasets: [
          { label: "Ingresos", data: [], borderColor: "#16a34a", backgroundColor: "#16a34a22", fill: true },
          { label: "Gastos", data: [], borderColor: "#ef4444", backgroundColor: "#ef444422", fill: true }
        ]},
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });

      chartUtilidad = new Chart($("#chartUtilidad"), {
        type: 'bar',
        data: { labels: [], datasets: [
          { label: "Utilidad", data: [], backgroundColor: "#0ea5e9" },
          { label: "Margen %", data: [], backgroundColor: "#f59e0b", yAxisID: 'y1' }
        ]},
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { y: { beginAtZero: true }, y1: { beginAtZero: true, position: 'right', ticks: { callback: v => v + "%" } } }
        }
      });
    }

    async function refreshCharts() {
      try {
        const today = new Date();
        const from = new Date(today.getTime() - 90*24*3600*1000);
        function fmt(d){ return d.toISOString().slice(0,10); }

        const salesSnap = await getDocs(collection(db, "companies", companyId, "sales"));
        const expSnap = await getDocs(collection(db, "companies", companyId, "expenses"));

        const byDateIn = {}, byDateOut = {};
        salesSnap.forEach(s => {
          const d = s.data();
          byDateIn[d.date] = (byDateIn[d.date]||0) + Number(d.precio||0);
        });
        expSnap.forEach(g => {
          const d = g.data();
          byDateOut[d.date] = (byDateOut[d.date]||0) + Number(g.monto||0);
        });

        const labels = [];
        for (let t=from; t<=today; t = new Date(t.getTime()+24*3600*1000)) labels.push(fmt(t));
        const ingresos = labels.map(l => byDateIn[l]||0);
        const gastos = labels.map(l => byDateOut[l]||0);

        chartIG.data.labels = labels;
        chartIG.data.datasets[0].data = ingresos;
        chartIG.data.datasets[1].data = gastos;
        chartIG.update();

        // utilidad por venta
        const ventas = []; salesSnap.forEach(s => ventas.push(s.data()));
        ventas.sort((a,b)=> (a.date < b.date ? -1:1));
        const ult = ventas.slice(-30);
        chartUtilidad.data.labels = ult.map(v => v.producto || "");
        chartUtilidad.data.datasets[0].data = ult.map(v => v.utilidad || 0);
        chartUtilidad.data.datasets[1].data = ult.map(v => Number(((v.margen||0)*100).toFixed(1)));
        chartUtilidad.update();

        // actualizar listas de metas y deudas para estadísticas
        await renderStatsLists();
      } catch (err) {
        console.error("refreshCharts error:", err);
      }
    }

    // render de listas en pestaña estadísticas
    async function renderStatsLists() {
      try {
        const statsMetas = $("#statsMetasList");
        const statsDeudas = $("#statsDeudasList");
        statsMetas.innerHTML = "";
        statsDeudas.innerHTML = "";

        const goalsSnap = await getDocs(collection(db, "companies", companyId, "goals"));
        goalsSnap.forEach(docu => {
          const g = docu.data();
          const objetivo = Number(g.objetivoMonto || 0);
          const acum = Number(g.acumulado || 0);
          const pct = objetivo ? Math.min(100, (acum/objetivo)*100) : 0;
          const faltante = Math.max(0, objetivo - acum);
          const div = document.createElement("div");
          div.innerHTML = `<div class="flex justify-between"><div><strong>${g.nombre}</strong> (${g.tipo})</div><div>${pct.toFixed(1)}%</div></div>
            <div class="text-xs text-slate-600">Objetivo: ${money(objetivo)} · Acum: ${money(acum)} · Falta: ${money(faltante)}</div>`;
          statsMetas.appendChild(div);
        });

        const debtsSnap = await getDocs(collection(db, "companies", companyId, "debts"));
        debtsSnap.forEach(docu => {
          const d = docu.data();
          const inicial = Number(d.montoInicial || 0);
          const saldo = Number(d.saldo || 0);
          const pagado = Math.max(0, inicial - saldo);
          const pct = inicial ? Math.min(100, (pagado / inicial) * 100) : 0;
          const div = document.createElement("div");
          div.innerHTML = `<div class="flex justify-between"><div><strong>${d.acreedor}</strong> (${d.acreedorTipo||''})</div><div>${pct.toFixed(1)}%</div></div>
            <div class="text-xs text-slate-600">Inicial: ${money(inicial)} · Pagado: ${money(pagado)} · Saldo: ${money(saldo)}</div>`;
          statsDeudas.appendChild(div);
        });

      } catch (err) {
        console.error("renderStatsLists error:", err);
      }
    }

    // Profile / settings
    $("#btnSelectCompany").addEventListener("click", async () => {
      const name = prompt("Nombre de empresa", "Joyería — Empresa");
      if (!name) return;
      await updateDoc(doc(db, "companies", companyId), { name });
      $("#companyName").textContent = name;
    });

    function setupPerfilButton() {
      $("#btnPerfil").addEventListener("click", async () => {
        try {
          const userRef = doc(db, "users", currentUser.uid);
          const snapU = await getDoc(userRef);
          const currentUserPct = snapU.exists() ? (snapU.data().ahorroSugeridoPct || 0) : 0;

          const compRef = doc(db, "companies", companyId);
          const snapC = await getDoc(compRef);
          const currentDebtPct = snapC.exists() ? (snapC.data().mandatoryDebtPct || 0.10) : 0.10;

          const inputUser = prompt("Porcentaje sugerido de ahorro personal (0-100). Ej: 20", String(Math.round(currentUserPct*100)));
          if (inputUser !== null) {
            const val = Number(inputUser);
            if (!isNaN(val) && val >=0 && val <=100) {
              await updateDoc(userRef, { ahorroSugeridoPct: val/100 });
              alert("Ahorro personal guardado: " + val + "%");
            } else alert("Valor inválido");
          }

          const inputDebt = prompt("Porcentaje obligatorio para deudas por ingreso (%). Ej: 10", String(Math.round(currentDebtPct*100)));
          if (inputDebt !== null) {
            const val2 = Number(inputDebt);
            if (!isNaN(val2) && val2 >=0 && val2 <=100) {
              await updateDoc(compRef, { mandatoryDebtPct: val2/100 });
              alert("Porcentaje de deudas guardado: " + val2 + "%");
            } else alert("Valor inválido");
          }

        } catch (err) {
          console.error(err); alert("Error guardando perfil");
        }
      });
    }

    // periodic refresh for charts and stats
    setInterval(() => { try { refreshCharts(); } catch(e){} }, 30_000);

    // initial: click first tab
    document.addEventListener("DOMContentLoaded", () => {
      const first = document.querySelector('.tab-btn');
      if (first) first.click();
      // hook UI toggles
      setupMovTipoToggle();
    });

=======
    // Subscribe balances (para KPI)
    function subscribeBalances() {
      const ref = doc(db, "companies", companyId, "state", "balances");
      const unsub = onSnapshot(ref, snap => {
        const d = snap.exists() ? snap.data() : {};
        $("#kpiCajaEmpresa").textContent = money(d.cajaEmpresa || 0);
        $("#kpiDeudas").textContent = money(d.deudasTotales || 0);
        // inventario total se actualiza en subscribeInventory
      });
      unsubscribers.push(unsub);
    }

    // calcula inventario total y lo pone en KPI
    function updateInventarioKPI() {
      let total = 0;
      for (const p of inventoryCache.values()) {
        total += Number(p.stock || 0);
      }
      $("#kpiInventarioTotal").textContent = total;
    }

    /**************************************************************************
     * INVENTORY: UI handlers (crear producto, renderizar, agregar stock)
     **************************************************************************/
    function setupInventoryHandlers() {
      $("#btnCreateProduct").addEventListener("click", async (e) => {
        e.preventDefault();
        await handleCreateProduct();
      });
    }

    // Crear producto (documento con stock inicial y attributes)
    async function handleCreateProduct() {
      const name = $("#prodName").value.trim();
      if (!name) return alert("Nombre requerido");
      const sku = $("#prodSku").value.trim() || null;
      const gender = $("#prodGender").value.trim() || null;
      const size = $("#prodSize").value.trim() || null;
      const color = $("#prodColor").value.trim() || null;
      const team = $("#prodTeam").value.trim() || null;
      const cost = Number($("#prodCost").value || 0);
      const price = Number($("#prodPrice").value || 0);
      const initialStock = Number($("#prodInitialStock").value || 0);
      const notes = $("#prodNotes").value.trim() || null;

      try {
        // Generar doc id automático
        const newRef = doc(collection(db, "companies", companyId, "inventory"));
        const productDoc = {
          name,
          sku,
          attributes: { gender, size, color, team },
          cost,
          price,
          stock: initialStock,
          notes,
          createdAt: serverTimestamp()
        };
        // escribir doc producto
        await setDoc(newRef, productDoc);

        // crear batch + movimiento en transacción para trazabilidad
        await runTransaction(db, async (tx) => {
          // crear batch nested collection
          const batchRef = doc(collection(db, "companies", companyId, "inventory", newRef.id, "batches"));
          tx.set(batchRef, {
            quantity_added: initialStock,
            remaining: initialStock,
            received_at: serverTimestamp(),
            note: "Stock inicial"
          });
          // movimiento de stock
          const movRef = doc(collection(db, "companies", companyId, "stock_movements"));
          tx.set(movRef, {
            productId: newRef.id,
            qty: initialStock,
            type: "in",
            note: "Stock inicial",
            refId: newRef.id,
            createdAt: serverTimestamp()
          });
        });

        // limpiar formulario
        $("#prodName").value = "";
        $("#prodSku").value = "";
        $("#prodGender").value = "";
        $("#prodSize").value = "";
        $("#prodColor").value = "";
        $("#prodTeam").value = "";
        $("#prodCost").value = "";
        $("#prodPrice").value = "";
        $("#prodInitialStock").value = "";
        $("#prodNotes").value = "";
        alert("Producto creado correctamente");

      } catch (err) {
        console.error("handleCreateProduct error", err);
        alert("Error creando producto: " + err.message);
      }
    }

    // Renderiza tabla inventario desde inventoryCache
    function renderInventoryTable() {
      const tb = $("#tbInventory");
      tb.innerHTML = "";
      const arr = Array.from(inventoryCache.values());
      if (!arr.length) {
        tb.innerHTML = `<tr><td colspan="5" class="small text-slate-500">No hay productos aún.</td></tr>`;
        return;
      }
      arr.forEach(p => {
        const attrs = [];
        if (p.attributes?.gender) attrs.push(p.attributes.gender);
        if (p.attributes?.size) attrs.push(p.attributes.size);
        if (p.attributes?.color) attrs.push(p.attributes.color);
        if (p.attributes?.team) attrs.push(p.attributes.team);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><strong>${escapeHtml(p.name)}</strong><div class="text-xs text-slate-500">${p.sku || ''}</div></td>
          <td class="small">${attrs.join(' • ')}</td>
          <td>${money(p.price)}</td>
          <td>${Number(p.stock || 0)}</td>
          <td>
            <button data-id="${p.id}" class="btnAddStock px-2 py-1 border rounded text-sm">+ Stock</button>
            <button data-id="${p.id}" class="btnEditProduct px-2 py-1 border rounded text-sm">Editar</button>
            <button data-id="${p.id}" class="btnDeleteProduct px-2 py-1 border rounded text-sm">Borrar</button>
          </td>
        `;
        tb.appendChild(tr);
      });

      // attach listeners
      $$(".btnAddStock").forEach(b => b.onclick = (ev) => {
        const id = ev.currentTarget.dataset.id;
        promptAddStock(id);
      });
      $$(".btnDeleteProduct").forEach(b => b.onclick = (ev) => {
        const id = ev.currentTarget.dataset.id;
        if (confirm("Borrar producto? Esta acción es irreversible.")) deleteProduct(id);
      });
      $$(".btnEditProduct").forEach(b => b.onclick = (ev) => {
        const id = ev.currentTarget.dataset.id;
        editProductModal(id);
      });
    }

    // Prompt simple para agregar stock (puedes mejorarlo a modal)
    async function promptAddStock(productId) {
      const qtyStr = prompt("¿Cuántas unidades quieres añadir al stock?");
      if (!qtyStr) return;
      const qty = Number(qtyStr);
      if (!qty || qty <= 0) return alert("Cantidad inválida");
      const note = prompt("Nota (opcional)", "Producción semanal");

      try {
        // run transaction: actualizar stock del producto + crear batch + movement
        await runTransaction(db, async (tx) => {
          const prodRef = doc(db, "companies", companyId, "inventory", productId);
          const prodSnap = await tx.get(prodRef);
          if (!prodSnap.exists()) throw new Error("Producto no existe");
          const oldStock = Number(prodSnap.data().stock || 0);
          const newStock = oldStock + qty;
          tx.update(prodRef, { stock: newStock });

          // batch
          const batchRef = doc(collection(db, "companies", companyId, "inventory", productId, "batches"));
          tx.set(batchRef, {
            quantity_added: qty,
            remaining: qty,
            received_at: serverTimestamp(),
            note: note || null
          });

          // movement
          const movRef = doc(collection(db, "companies", companyId, "stock_movements"));
          tx.set(movRef, {
            productId,
            qty,
            type: "in",
            note: note || null,
            refId: batchRef.id,
            createdAt: serverTimestamp()
          });
        });
        alert("Stock actualizado");
      } catch (err) {
        console.error("promptAddStock error", err);
        alert("Error en agregar stock: " + err.message);
      }
    }

    async function deleteProduct(productId) {
      try {
        await deleteDoc(doc(db, "companies", companyId, "inventory", productId));
        alert("Producto eliminado");
      } catch (err) {
        console.error(err);
        alert("Error al eliminar");
      }
    }

    function editProductModal(productId) {
      const p = inventoryCache.get(productId);
      if (!p) return alert("No encontrado");
      // Simple prompt-based edit (para MVP). Puedes reemplazar por modal.
      const newPrice = prompt("Nuevo precio", p.price || 0);
      if (newPrice === null) return;
      const newCost = prompt("Nuevo costo", p.cost || 0);
      if (newCost === null) return;
      updateDoc(doc(db, "companies", companyId, "inventory", productId), {
        price: Number(newPrice),
        cost: Number(newCost)
      }).then(() => alert("Producto actualizado")).catch(err => {
        console.error(err);
        alert("Error actualizando");
      });
    }

    /**************************************************************************
     * POS / VENTAS: UX & transacción segura (CORREGIDA + ACTUALIZA BALANCES)
     * - Ahora la transacción lee *todos* los documentos primero y luego hace
     *   las escrituras: regla obligatoria de Firestore.
     * - Además actualiza companies/{companyId}/state/balances.cajaEmpresa
     **************************************************************************/
    function setupPosHandlers() {
      $("#btnAddCartLine").onclick = () => createCartLine();
      $("#btnClearCart").onclick = () => { $("#cartBody").innerHTML = ""; updateCartTotal(); };
      $("#btnSubmitSale").onclick = submitSaleHandler;
      // create one line by default
      createCartLine();
    }

    // Genera una fila en la tabla de carrito
    function createCartLine() {
      const tr = document.createElement("tr");
      // cada select tendrá data-product-id en option.value
      const selectHtml = `<select class="prodSelect w-full border rounded p-1">
        <option value="">-- seleccionar --</option>
      </select>`;
      tr.innerHTML = `
        <td>${selectHtml}</td>
        <td><input type="number" class="lineQty border rounded p-1 w-24" min="1" value="1"></td>
        <td><input type="number" class="linePrice border rounded p-1 w-32" min="0" step="0.01"></td>
        <td class="lineSubtotal">${money(0)}</td>
        <td><button class="btnRemoveLine px-2 py-1 border rounded">Eliminar</button></td>
      `;
      $("#cartBody").appendChild(tr);

      // populate select options with current inventory
      populateProductSelectElement(tr.querySelector(".prodSelect"));

      // events
      tr.querySelector(".prodSelect").onchange = (e) => {
        const pid = e.target.value;
        if (!pid) {
          tr.querySelector(".linePrice").value = 0;
          tr.querySelector(".lineQty").value = 1;
          updateLineSubtotal(tr);
          return;
        }
        const p = inventoryCache.get(pid);
        tr.dataset.productId = pid;
        tr.querySelector(".linePrice").value = p.price || 0;
        tr.querySelector(".lineQty").value = 1;
        updateLineSubtotal(tr);
      };
      tr.querySelector(".lineQty").oninput = () => updateLineSubtotal(tr);
      tr.querySelector(".linePrice").oninput = () => updateLineSubtotal(tr);
      tr.querySelector(".btnRemoveLine").onclick = () => { tr.remove(); updateCartTotal(); };
    }

    // Pone options en un select HTML desde inventoryCache
    function populateProductSelectElement(selectEl) {
      selectEl.innerHTML = `<option value="">-- seleccionar --</option>`;
      Array.from(inventoryCache.values()).forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        // label: nombre + attrs
        const attrs = [];
        if (p.attributes?.gender) attrs.push(p.attributes.gender);
        if (p.attributes?.size) attrs.push(p.attributes.size);
        if (p.attributes?.color) attrs.push(p.attributes.color);
        if (p.attributes?.team) attrs.push(p.attributes.team);
        opt.text = `${p.name} ${attrs.length ? "(" + attrs.join(" • ") + ")" : ""} — Stock: ${p.stock || 0}`;
        selectEl.appendChild(opt);
      });
    }

    // actualiza todos los selects en el POS cuando cambia inventario
    function populateProductSelects() {
      $$(".prodSelect").forEach(sel => populateProductSelectElement(sel));
    }

    function updateLineSubtotal(tr) {
      const q = Number(tr.querySelector(".lineQty").value || 0);
      const p = Number(tr.querySelector(".linePrice").value || 0);
      const sub = q * p;
      tr.querySelector(".lineSubtotal").textContent = money(sub);
      updateCartTotal();
    }

    function updateCartTotal() {
      const rows = Array.from($("#cartBody").querySelectorAll("tr"));
      let total = 0;
      rows.forEach(r => {
        // extraer subtotal limpiando moneda
        const subStr = r.querySelector(".lineSubtotal").textContent || "$0";
        const sub = Number(subStr.replace(/\$/g,'').replace(/\./g,'').replace(/\,/g,'.')) || 0;
        total += sub;
      });
      $("#cartTotal").textContent = money(total);
    }

    // Handler submit: construye payload y ejecuta transacción (CORREGIDO)
    async function submitSaleHandler() {
      const rows = Array.from($("#cartBody").querySelectorAll("tr"));
      if (!rows.length) return alert("El carrito está vacío");

      // construir items
      const items = [];
      for (const r of rows) {
        const pid = r.dataset.productId;
        if (!pid) return alert("Selecciona producto en todas las líneas");
        const qty = Number(r.querySelector(".lineQty").value || 0);
        const price = Number(r.querySelector(".linePrice").value || 0);
        if (qty <= 0) return alert("Cantidad inválida");
        const prod = inventoryCache.get(pid);
        if (!prod) return alert("Producto no encontrado (recarga)");
        items.push({ productId: pid, name: prod.name, qty, price });
      }
      const total = items.reduce((s, it) => s + (it.qty * it.price), 0);
      const saleDoc = {
        createdAt: serverTimestamp(),
        createdBy: currentUser.uid,
        client: $("#saleClient").value.trim() || null,
        type: $("#saleType").value,
        channel: $("#saleChannel").value,
        total,
        items
      };

      // Ejecutar transacción atómica CORRECTA:
      // 1) leer TODOS los productos (tx.get) -> validar stock
      // 2) luego hacer las escrituras: update stock, set sale, set stock_movements, set movimiento caja
      try {
        await runTransaction(db, async (tx) => {
          // --- 1) Lecturas: obtener snapshot de cada producto involucrado ---
          const prodSnaps = {}; // productId -> DocumentSnapshot
          for (const it of items) {
            const prodRef = doc(db, "companies", companyId, "inventory", it.productId);
            const snap = await tx.get(prodRef);
            if (!snap.exists()) {
              throw new Error(`Producto ${it.name} no existe (id=${it.productId})`);
            }
            prodSnaps[it.productId] = { ref: prodRef, data: snap.data() };
          }

          // Leer balances (documento que usamos para la KPI de caja)
          const balancesRef = doc(db, "companies", companyId, "state", "balances");
          const balancesSnap = await tx.get(balancesRef);
          const oldCaja = balancesSnap.exists() ? Number(balancesSnap.data().cajaEmpresa || 0) : 0;

          // Validar stock en memoria con los datos leídos
          for (const it of items) {
            const currentStock = Number(prodSnaps[it.productId].data.stock || 0);
            if (currentStock < it.qty) {
              throw new Error(`Stock insuficiente para ${it.name}. Disponible: ${currentStock}`);
            }
          }

          // --- 2) Escrituras: ahora sí hacemos updates/sets ---
          // 2.1 actualizar stock por producto
          for (const it of items) {
            const prodRef = prodSnaps[it.productId].ref;
            const currentStock = Number(prodSnaps[it.productId].data.stock || 0);
            const newStock = currentStock - it.qty;
            tx.update(prodRef, { stock: newStock });
          }

          // 2.2 crear sale doc
          const saleRef = doc(collection(db, "companies", companyId, "sales"));
          tx.set(saleRef, saleDoc);

          // 2.3 crear stock_movements por cada item (auditoría)
          for (const it of items) {
            const movRef = doc(collection(db, "companies", companyId, "stock_movements"));
            tx.set(movRef, {
              productId: it.productId,
              qty: -it.qty,            // negativo = salida
              type: "out",
              note: `Venta (${it.qty} x ${it.name})`,
              refId: saleRef.id,
              createdAt: serverTimestamp()
            });
          }

          // 2.4 crear movimiento de caja (ingreso)
          const movCajaRef = doc(collection(db, "companies", companyId, "movements"));
          tx.set(movCajaRef, {
            tipo: "ingreso",
            cuenta: "cajaEmpresa",
            fecha: new Date().toISOString().slice(0,10),
            monto: total,
            desc: `Venta total ID ${saleRef.id}`,
            saleId: saleRef.id,
            createdAt: serverTimestamp()
          });

          // 2.5 actualizar balances (cajaEmpresa) en el mismo tx
          const newCaja = oldCaja + Number(total || 0);
          if (balancesSnap.exists()) {
            tx.update(balancesRef, { cajaEmpresa: newCaja });
          } else {
            // si no existía balances, crear doc con valor inicial
            tx.set(balancesRef, { cajaEmpresa: newCaja, deudasTotales: 0, createdAt: serverTimestamp() });
          }
        });

        // si todo OK
        alert("Venta registrada correctamente");
        // limpiar carrito
        $("#cartBody").innerHTML = "";
        updateCartTotal();
      } catch (err) {
        console.error("submitSaleHandler error:", err);
        alert("Error al crear venta: " + (err.message || err));
      }
    }

    /**************************************************************************
     * RENDER ventas (lista)
     **************************************************************************/
    function renderSalesTable() {
  const tbody = document.querySelector("#tbVentas");
  tbody.innerHTML = "";

  salesCache.forEach(sale => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="border px-2 py-1">${new Date(sale.createdAt?.toDate?.() || Date.now()).toLocaleString()}</td>
      <td class="border px-2 py-1">${sale.items.map(i => `${i.qty} x ${i.name}`).join("<br>")}</td>
      <td class="border px-2 py-1">${money(sale.total)}</td>
      <td class="border px-2 py-1">
        <button class="bg-red-500 text-white px-2 py-1 rounded text-xs delete-sale" data-id="${sale.id}">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // conectar botones eliminar
  $$(".delete-sale").forEach(btn => {
    btn.onclick = async () => {
      const saleId = btn.dataset.id;
      if (confirm("¿Seguro que deseas eliminar esta venta?")) {
        await deleteSale(saleId);
      }
    };
  });
}

    /**************************************************************************
     * CHARTS (básicos)
     **************************************************************************/
    let chartTopProducts = null;
    let chartVentasPorDia = null;

    function setupCharts() {
      const ctx1 = document.getElementById("chartTopProducts").getContext("2d");
      chartTopProducts = new Chart(ctx1, { type: 'bar', data: { labels: [], datasets: [{ label: 'Vendidos', data: [], backgroundColor: 'rgba(16,185,129,0.8)' }] }, options: {} });

      const ctx2 = document.getElementById("chartVentasPorDia").getContext("2d");
      chartVentasPorDia = new Chart(ctx2, { type: 'line', data: { labels: [], datasets: [{ label: 'Ventas', data: [], borderColor: 'rgba(15,118,110,1)', backgroundColor: 'rgba(15,118,110,0.2)' }] }, options: {} });
    }

    // Actualiza datos de charts con salesCache + inventoryCache
    function updateCharts() {
      // Top products: sumar qty por productId en salesCache
      const counter = {};
      salesCache.forEach(s => {
        (s.items || []).forEach(it => {
          counter[it.productId] = (counter[it.productId] || 0) + it.qty;
        });
      });
      const top = Object.entries(counter).sort((a,b) => b[1]-a[1]).slice(0,8);
      const labels = top.map(([pid]) => {
        const p = inventoryCache.get(pid);
        return p ? `${p.name} ${p.attributes?.size||''} ${p.attributes?.color||''}` : pid;
      });
      const data = top.map(([_,qty]) => qty);
      chartTopProducts.data.labels = labels;
      chartTopProducts.data.datasets[0].data = data;
      chartTopProducts.update();

      // Ventas por día (últimos 30)
      const mapDays = {}; // 'YYYY-MM-DD' -> total
      const now = new Date();
      for (let i=29;i>=0;i--) {
        const d = new Date(now); d.setDate(now.getDate()-i);
        const key = d.toISOString().slice(0,10);
        mapDays[key] = 0;
      }
      salesCache.forEach(s => {
        const key = s.createdAt?.seconds ? new Date(s.createdAt.seconds*1000).toISOString().slice(0,10) : new Date().toISOString().slice(0,10);
        if (mapDays[key] !== undefined) mapDays[key] += Number(s.total || 0);
      });
      const labels2 = Object.keys(mapDays);
      const data2 = Object.values(mapDays);
      chartVentasPorDia.data.labels = labels2;
      chartVentasPorDia.data.datasets[0].data = data2;
      chartVentasPorDia.update();
    }

    /**************************************************************************
     * FUNCIONES: Caja por rango
     * computeCajaTotal: suma movimientos (movements) filtrando por cuenta=cajaEmpresa
     **************************************************************************/
    // Nota: usa getDocs + query + where
    async function computeCajaTotal(fromDate, toDate) {
      try {
        const movCol = collection(db, "companies", companyId, "movements");
        const q = query(
          movCol,
          where("cuenta", "==", "cajaEmpresa"),
          where("createdAt", ">=", fromDate),
          where("createdAt", "<=", toDate)
        );
        const snap = await getDocs(q);
        let total = 0;
        snap.forEach(d => {
          const md = d.data();
          const m = Number(md.monto || 0);
          total += (md.tipo === "egreso") ? -m : m;
        });
        return total;
      } catch (err) {
        console.error("computeCajaTotal error:", err);
        throw err;
      }
    }

    function formatDateForLabel(d) {
      return d.toISOString().slice(0,10);
    }

    function setupCajaControls() {
      // mostrar/hide custom
      $("#btnCajaCustomToggle").onclick = () => {
        $("#cajaCustom").classList.toggle("hidden");
      };

      $("#btnCajaHoy").onclick = async () => {
        const today = new Date();
        const from = new Date(today); from.setHours(0,0,0,0);
        const to = new Date(today); to.setHours(23,59,59,999);
        try {
          const total = await computeCajaTotal(from, to);
          $("#kpiCajaRangeResult").textContent = `Caja hoy (${formatDateForLabel(from)}): ${money(total)}`;
        } catch (err) {
          alert("Error calculando caja hoy: " + err.message);
        }
      };

      $("#btnCaja7d").onclick = async () => {
        const today = new Date();
        const from = new Date(today); from.setDate(today.getDate() - 6); from.setHours(0,0,0,0); // últimos 7 días (incluye hoy)
        const to = new Date(today); to.setHours(23,59,59,999);
        try {
          const total = await computeCajaTotal(from, to);
          $("#kpiCajaRangeResult").textContent = `Caja últimos 7 días (${formatDateForLabel(from)} → ${formatDateForLabel(to)}): ${money(total)}`;
        } catch (err) {
          alert("Error calculando 7 días: " + err.message);
        }
      };

      $("#btnCaja30d").onclick = async () => {
        const today = new Date();
        const from = new Date(today); from.setDate(today.getDate() - 29); from.setHours(0,0,0,0);
        const to = new Date(today); to.setHours(23,59,59,999);
        try {
          const total = await computeCajaTotal(from, to);
          $("#kpiCajaRangeResult").textContent = `Caja últimos 30 días (${formatDateForLabel(from)} → ${formatDateForLabel(to)}): ${money(total)}`;
        } catch (err) {
          alert("Error calculando 30 días: " + err.message);
        }
      };

      $("#btnCajaCustom").onclick = async () => {
        const fromStr = $("#cajaFrom").value;
        const toStr = $("#cajaTo").value;
        if (!fromStr || !toStr) return alert("Selecciona ambas fechas");
        const from = new Date(fromStr); from.setHours(0,0,0,0);
        const to = new Date(toStr); to.setHours(23,59,59,999);
        if (to < from) return alert("Rango inválido");
        try {
          const total = await computeCajaTotal(from, to);
          $("#kpiCajaRangeResult").textContent = `Caja (${formatDateForLabel(from)} → ${formatDateForLabel(to)}): ${money(total)}`;
        } catch (err) {
          alert("Error calculando rango: " + err.message);
        }
      };
    }

    /**************************************************************************
     * UTIL: escapeHtml
     **************************************************************************/
    function escapeHtml(s) {
      if (!s) return '';
      return String(s).replace(/[&<>"'`=\/]/g, function (c) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c];
      });
    }

    /**************************************************************************
     * Utilities finales: puedes usarlas para debug en consola
     **************************************************************************/
    window._dbg = {
      db,
      inventoryCache,
      salesCache,
      runTransaction
    };
>>>>>>> 6d8c9b0567348a948b9adda09138a5bca391873f
  </script>
</body>
</html>
